<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance App | Kiosk</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1063/1063376.png">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1063/1063376.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { margin: 0; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #f0f2f5; font-family: 'Segoe UI', Arial, sans-serif; }
    
    .connection-status { margin-bottom: 10px; font-size: 12px; font-weight: bold; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .status-connected { color: #2ecc71; }
    .status-connected .status-dot { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
    .status-disconnected { color: #e74c3c; }
    .status-disconnected .status-dot { background-color: #e74c3c; }

    .attendance-box { 
        background-color: #ffffff; 
        padding: 20px; 
        border-radius: 12px; 
        box-shadow: 0 8px 24px rgba(0,0,0,0.1); 
        text-align: center; 
        width: 90%; 
        max-width: 400px; 
    }
    
    h3 { color: #2c3e50; margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

    select, input[type="text"], input[type="number"] { width: 100%; padding: 12px 8px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; background-color: #fff; outline: none; box-sizing: border-box; }

    input[type="tel"] { width: 100%; padding: 15px; margin-bottom: 25px; border: 2px solid #ddd; border-radius: 8px; font-size: 28px; text-align: center; letter-spacing: 5px; outline: none; box-sizing: border-box; }
    input:focus, select:focus { border-color: #3498db; }

    .btn-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
    .btn { flex: 1; padding: 16px; border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
    .login-btn { background-color: #2ecc71; }
    .logout-btn { background-color: #e74c3c; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .request-btn { 
        width: 90%; 
        max-width: 400px; 
        background-color: #34495e; 
        padding: 14px; 
        border: none; 
        border-radius: 8px; 
        color: white; 
        font-weight: bold; 
        cursor: pointer; 
        text-transform: uppercase; 
        letter-spacing: 1px;
        margin-top: 20px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: 0.2s;
    }
    .btn:hover:not(:disabled), .request-btn:hover { opacity: 0.9; transform: translateY(-1px); }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-content { background: white; padding: 25px 15px; border-radius: 15px; text-align: center; max-width: 500px; width: 95%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    
    .request-row { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; }
    .req-item { flex: 2; min-width: 0; }
    .req-qty { flex: 0.6; min-width: 0; text-align: center; }
    .req-unit { flex: 1; min-width: 0; }
    .request-row input, .request-row select { margin-bottom: 0; }

    .close-modal-btn { margin-top: 20px; padding: 12px 30px; background: #3498db; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .submit-req-btn { padding: 12px 30px; background: #2ecc71; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
  </style>
</head>
<body>

  <div id="dbStatus" class="connection-status status-disconnected">
    <span class="status-dot"></span>
    <span id="statusText">Disconnected</span>
  </div>

  <div class="attendance-box">
    <h3>Project Site</h3>
    <select id="projectSite">
      <option value="">Connecting to database...</option>
    </select>

    <h3>Input ID Number</h3>
    <input type="tel" id="employeeId" placeholder="0000" inputmode="numeric" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
    
    <div class="btn-container">
      <button id="loginBtn" class="btn login-btn">Login</button>
      <button id="logoutBtn" class="btn logout-btn">Logout</button>
    </div>
  </div>

  <button class="request-btn" onclick="openRequestModal()">Request Materials</button>

  <div class="modal-overlay" id="statusModal">
    <div class="modal-content">
      <div id="modalIcon"></div>
      <h2 id="modalHeader" style="margin-top: 0;"></h2>
      <p id="modalMessage" style="font-size: 18px; line-height: 1.5; color: #444;"></p>
      <button class="close-modal-btn" onclick="closeStatusModal()">OK</button>
    </div>
  </div>

  <div class="modal-overlay" id="requestModal">
    <div class="modal-content">
      <h3 style="margin-top: 0; margin-bottom: 15px; color: #2c3e50;">Tools & Materials</h3>
      
      <div class="request-row">
        <input type="text" id="reqItem" class="req-item" placeholder="Item Name">
        <input type="number" id="reqQty" class="req-qty" placeholder="0" min="1">
        <select id="reqUnit" class="req-unit">
          <option value="pcs">pcs</option>
          <option value="box">box</option>
          <option value="set">set</option>
          <option value="kilo">kilo</option>
          <option value="liter">liter</option>
          <option value="meter">meter</option>
          <option value="inch">inch</option>
          <option value="roll">roll</option>
        </select>
      </div>

      <button id="submitReqBtn" class="submit-req-btn" onclick="submitRequest()">Submit Request</button>
      <button onclick="closeRequestModal()" style="background:none; border:none; color:#7f8c8d; cursor:pointer; margin-top:15px; text-decoration:underline;">Cancel</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = 'https://xudyewfvojyplmhuvcua.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_NqLlWMfWBBXx2D_hwuJ2tw_eKhsh0sq';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const input = document.getElementById('employeeId');
    const siteSelect = document.getElementById('projectSite');
    const modal = document.getElementById('statusModal');
    const reqModal = document.getElementById('requestModal');
    const dbStatus = document.getElementById('dbStatus');
    const statusText = document.getElementById('statusText');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    function openRequestModal() { reqModal.style.display = 'flex'; }
    function closeRequestModal() { reqModal.style.display = 'none'; }
    
    async function submitRequest() {
        const item = document.getElementById('reqItem').value.trim();
        const qty = document.getElementById('reqQty').value.trim();
        const unit = document.getElementById('reqUnit').value;
        const selectedSiteInput = siteSelect.value; 
        const btn = document.getElementById('submitReqBtn');
        
        if(!selectedSiteInput) return alert("Please select a Project Site first.");
        if(!item || !qty) return alert("Please fill in both Item and Quantity.");

        btn.disabled = true;
        btn.innerText = "Validating...";

        try {
            const { data: siteData, error: siteError } = await supabase
                .from('project_sites')
                .select('site_name')
                .eq('site_name', selectedSiteInput)
                .maybeSingle();

            if (siteError) throw siteError;
            if (!siteData) throw new Error("Selected Site no longer valid.");

            const { error: insertError } = await supabase
                .from('material_requests')
                .insert([{
                    site_name: siteData.site_name,
                    item_name: item,
                    quantity: parseInt(qty),
                    unit: unit,
                    created_at: new Date().toISOString()
                }]);

            if (insertError) throw insertError;

            closeRequestModal();
            showStatusModal(
                "Request Sent", 
                `<i class="fas fa-check-circle" style="font-size: 40px; color: #2ecc71; margin-bottom: 10px; display: block;"></i>
                 Your request for <b>${qty} ${unit}</b> of <b>${item}</b> has been submitted.`, 
                "#2ecc71"
            );
            
            document.getElementById('reqItem').value = '';
            document.getElementById('reqQty').value = '';

        } catch (err) {
            alert("Submission Failed: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "Submit Request";
        }
    }

    function updateStatus(isConnected) {
        dbStatus.className = isConnected ? 'connection-status status-connected' : 'connection-status status-disconnected';
        statusText.innerText = isConnected ? 'Connected' : 'Disconnected';
    }

    async function loadSites() {
      const { data, error } = await supabase.from('project_sites').select('site_name').order('site_name', { ascending: true });
      if (error) { updateStatus(false); return; }
      updateStatus(true);
      siteSelect.innerHTML = '<option value="">-- Select Location --</option>';
      data.forEach(site => {
        const option = document.createElement('option');
        option.value = site.site_name; 
        option.textContent = site.site_name;
        siteSelect.appendChild(option);
      });
    }

    function showStatusModal(header, message, color) {
      const headerEl = document.getElementById('modalHeader');
      headerEl.innerText = header; headerEl.style.color = color;
      document.getElementById('modalMessage').innerHTML = message;
      modal.style.display = 'flex';
    }

    function closeStatusModal() { 
        modal.style.display = 'none'; 
        input.focus(); // Returns focus to input for next user
    }

    async function handleAttendance(type) {
      const id = input.value.trim();
      const site = siteSelect.value;
      const currentBtn = type === 'login' ? loginBtn : logoutBtn;

      if (!id) return alert("Please enter your Employee ID.");
      if (type === 'login' && !site) return alert("Please select a Project Site to Login.");

      // Disable buttons to prevent double submission
      loginBtn.disabled = true;
      logoutBtn.disabled = true;

      try {
          const { data: employee, error: empError } = await supabase.from('employees').select('full_name').eq('id', id).maybeSingle();
          if (empError) throw new Error("Connection Error.");
          if (!employee) throw new Error("Employee ID not found.");

          const now = new Date();
          const currentTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
          const currentDate = now.toISOString().split('T')[0];

          if (type === 'login') {
            const { error } = await supabase.from('attendance_logs').insert([{
              employee_id: id, full_name: employee.full_name, date: currentDate, login_time: currentTime, project_site: site
            }]);
            if (error) throw new Error("Error saving Login.");
            
            showStatusModal("Welcome!", `Hello, <b>${employee.full_name}</b>!<br>${site} @ ${currentTime}`, "#2ecc71");
          } else {
            const { data: activeLog } = await supabase.from('attendance_logs').select('id, project_site').eq('employee_id', id).eq('date', currentDate).is('logout_time', null).order('id', { ascending: false }).limit(1).maybeSingle();
            
            if (!activeLog) throw new Error("No active Login record found.");
            
            const { error: updateError } = await supabase.from('attendance_logs').update({ logout_time: currentTime }).eq('id', activeLog.id);
            if (updateError) throw new Error("Error saving Logout.");

            showStatusModal("Goodbye!", `Great job, <b>${employee.full_name}</b>!<br>Out from ${activeLog.project_site} @ ${currentTime}`, "#e74c3c");
          }

          // SUCCESS: Reset the input field
          input.value = '';

      } catch (err) {
          alert(err.message);
      } finally {
          loginBtn.disabled = false;
          logoutBtn.disabled = false;
      }
    }

    loginBtn.addEventListener('click', () => handleAttendance('login'));
    logoutBtn.addEventListener('click', () => handleAttendance('logout'));
    loadSites();
  </script>
</body>
</html>